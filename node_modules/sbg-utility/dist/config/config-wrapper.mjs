import EventEmitter from 'events';
import fs from 'fs-extra';
import url from 'node:url';
import path from 'upath';
import 'path';
import 'bluebird';
import 'minimatch';
import '../utils/filemanager/getAppRootDir.mjs';
import '../utils/filemanager/path-utility.mjs';
import '../utils/logger.mjs';
import { writefile } from '../utils/filemanager/writefile.mjs';

const __filename = url.fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const configWrapperFile = path.join(__dirname, '_config_wrapper.json');
if (!fs.existsSync(configWrapperFile)) fs.writeFileSync(configWrapperFile, '{}');
const configWrapper = fs.existsSync(fs.readFileSync(configWrapperFile, 'utf-8')) ? JSON.parse(configWrapperFile) : {};
/**
 * Create/Update config wrapper
 */
// eslint-disable-next-line @typescript-eslint/no-unsafe-declaration-merging
class createConfig extends EventEmitter {
  cname;
  /**
   * Create/Update config wrapper
   * @param name config name
   * @param value initial config value
   */
  constructor(name, value) {
    super();
    // assign config name
    this.cname = name;
    // add config
    if (!configWrapper[name]) {
      configWrapper[name] = value;
      this.emit('add', value);
    } else {
      // update config
      this.update(value);
    }
  }
  /**
   * get config
   * @returns
   */
  get() {
    if (!configWrapper[this.cname]) configWrapper[this.cname] = {};
    return configWrapper[this.cname];
  }
  /**
   * update config
   * @param value new values should be merged with old values using shallow object merge
   */
  update(value) {
    configWrapper[this.cname] = Object.assign({}, this.get(), value);
    fs.accessSync(configWrapperFile, fs.constants.W_OK);
    writefile(configWrapperFile, JSON.stringify(configWrapper, null, 2));
    this.emit('update');
  }
}

export { createConfig };
